<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bored Ape Shib Club</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 10px;
            min-height: 100vh;
        }
        #nftCanvas {
            border: 2px solid #333;
            background-color: #fff;
            width: 100%;
            max-width: 512px;
            height: auto;
        }
        .header {
            text-align: center;
            margin-bottom: 10px;
        }
        .wallet-info {
            margin: 10px 0;
            font-size: 14px;
            color: #333;
        }
        .controls {
            margin: 10px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            width: 100%;
            max-width: 600px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 120px;
        }
        label {
            margin-bottom: 3px;
            font-weight: bold;
            font-size: 14px;
        }
        .layer-value {
            margin-bottom: 3px;
            font-size: 12px;
            text-align: center;
            height: 18px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 100%;
        }
        .cycle-buttons {
            display: flex;
            gap: 5px;
        }
        .cycle-btn {
            padding: 3px 8px;
            font-size: 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .cycle-btn:hover {
            background-color: #45a049;
        }
        select {
            margin-top: 5px;
            padding: 3px;
            font-size: 12px;
            width: 100%;
            border-radius: 5px;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        .action-btn {
            padding: 8px 16px;
            font-size: 14px;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #connectWalletBtn {
            background-color: #FF8A9D;
        }
        #connectWalletBtn:hover {
            background-color: #FF6F85;
        }
        #randomizeBtn {
            background-color: #4CAF50;
        }
        #randomizeBtn:hover {
            background-color: #45a049;
        }
        #downloadBtn {
            background-color: #008CBA;
        }
        #downloadBtn:hover {
            background-color: #007bb5;
        }
        #mintBtn {
            background-color: #FF8A9D;
        }
        #mintBtn:hover {
            background-color: #FF6F85;
        }
        .action-btn:disabled {
            background-color: #A8A2C0;
            cursor: not-allowed;
        }
        .action-btn.loading {
            opacity: 0.7;
            pointer-events: none;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: #FFF5F7;
            padding: 20px;
            border-radius: 20px;
            text-align: center;
            color: #5A4A6F;
            max-width: 320px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            border: 2px solid #FFD1D9;
        }
        .modal-content p {
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        .modal-content button {
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.95em;
            background: #FF8A9D;
            color: #fff;
            border: none;
            cursor: pointer;
        }
        @media (max-width: 600px) {
            .control-group {
                width: 100px;
            }
            label {
                font-size: 12px;
            }
            .layer-value {
                font-size: 10px;
                height: 16px;
            }
            .cycle-btn {
                padding: 2px 6px;
                font-size: 10px;
            }
            select {
                font-size: 10px;
                padding: 2px;
            }
            .action-btn {
                padding: 6px 12px;
                font-size: 12px;
            }
            .wallet-info {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Bored Ape Shib Club</h1>
        <div class="wallet-info">
            Wallet: <span id="walletAddress">Not connected</span><br>
            <a href="https://shibfun.github.io/BoredApeShibClub/" target="_blank">Home</a>
        </div>
        <button id="connectWalletBtn" class="action-btn">Connect Wallet</button>
    </div>
    <div class="controls">
        <div class="control-group">
            <label>Background</label>
            <div id="backgroundValue" class="layer-value">Cool Gray</div>
            <div class="cycle-buttons">
                <button class="cycle-btn" onclick="cycleLayer('Background', -1)">Prev</button>
                <button class="cycle-btn" onclick="cycleLayer('Background', 1)">Next</button>
            </div>
            <select id="backgroundSelect" onchange="selectLayer('Background')">
                <option value="0">Cool Gray</option>
                <option value="1">Dark Blue</option>
                <option value="2">Dark Purple</option>
                <option value="3">Off White A</option>
                <option value="4">Off White B</option>
                <option value="5">Off White C</option>
                <option value="6">Off White D</option>
                <option value="7">Red</option>
            </select>
        </div>
        <div class="control-group">
            <label>Fur</label>
            <div id="furValue" class="layer-value">Black</div>
            <div class="cycle-buttons">
                <button class="cycle-btn" onclick="cycleLayer('Fur', -1)">Prev</button>
                <button class="cycle-btn" onclick="cycleLayer('Fur', 1)">Next</button>
            </div>
            <select id="furSelect" onchange="selectLayer('Fur')">
                <option value="0">Black</option>
                <option value="1">Blue</option>
                <option value="2">Brown</option>
                <option value="3">Cheetah</option>
                <option value="4">Cream</option>
                <option value="5">Dark Brown</option>
                <option value="6">Death Bot</option>
                <option value="7">DMT</option>
                <option value="8">Golden Brown</option>
                <option value="9">Gray</option>
                <option value="10">Noise</option>
                <option value="11">Pink</option>
                <option value="12">Red</option>
                <option value="13">Robot</option>
                <option value="14">Solid Gold</option>
                <option value="15">Tan</option>
                <option value="16">Trippy</option>
                <option value="17">White</option>
                <option value="18">Zombie</option>
            </select>
        </div>
        <div class="control-group">
            <label>Clothes</label>
            <div id="clothesValue" class="layer-value">None</div>
            <div class="cycle-buttons">
                <button class="cycle-btn" onclick="cycleLayer('Clothes', -1)">Prev</button>
                <button class="cycle-btn" onclick="cycleLayer('Clothes', 1)">Next</button>
            </div>
            <select id="clothesSelect" onchange="selectLayer('Clothes')">
                <option value="0">None</option>
                <option value="1">Admirals Coat</option>
                <option value="2">Bandolier</option>
                <option value="3">Bayc T Black</option>
                <option value="4">Bayc T Red</option>
                <option value="5">Biker Vest</option>
                <option value="6">Black Holes T</option>
                <option value="7">Black Suit</option>
                <option value="8">Black T</option>
                <option value="9">Blue Dress</option>
                <option value="10">Bone Necklace</option>
                <option value="11">Bone Tee</option>
                <option value="12">Caveman Pelt</option>
                <option value="13">Cowboy Shirt</option>
                <option value="14">Guayabera</option>
                <option value="15">Hawaiian</option>
                <option value="16">Hip Hop</option>
                <option value="17">Kings Robe</option>
                <option value="18">Lab Coat</option>
                <option value="19">Leather Jacket</option>
                <option value="20">Leather Punk Jacket</option>
                <option value="21">Lumberjack Shirt</option>
                <option value="22">Navy Striped Tee</option>
                <option value="23">Pimp Coat</option>
                <option value="24">Prison Jumpsuit</option>
                <option value="25">Prom Dress</option>
                <option value="26">Puffy Vest</option>
                <option value="27">Rainbow Suspenders</option>
                <option value="28">Sailor Shirt</option>
                <option value="29">Service</option>
                <option value="30">Sleeveless Logo T</option>
                <option value="31">Sleeveless T</option>
                <option value="32">Smoking Jacket</option>
                <option value="33">Space suit</option>
                <option value="34">Striped Tee</option>
                <option value="35">Stunt Jacket</option>
                <option value="36">Tanktop</option>
                <option value="37">Tie Dye</option>
                <option value="38">Toga</option>
                <option value="39">Tuxedo Tee</option>
                <option value="40">Tweed Suit</option>
                <option value="41">Vietnam Jacket</option>
                <option value="42">Wool Turtleneck</option>
                <option value="43">Work Vest</option>
            </select>
        </div>
        <div class="control-group">
            <label>Eyes</label>
            <div id="eyesValue" class="layer-value">3D</div>
            <div class="cycle-buttons">
                <button class="cycle-btn" onclick="cycleLayer('Eyes', -1)">Prev</button>
                <button class="cycle-btn" onclick="cycleLayer('Eyes', 1)">Next</button>
            </div>
            <select id="eyesSelect" onchange="selectLayer('Eyes')">
                <option value="0">3D</option>
                <option value="1">Angry</option>
                <option value="2">Blindfold</option>
                <option value="3">Bloodshot</option>
                <option value="4">Blue Beams</option>
                <option value="5">Bored</option>
                <option value="6">Closed</option>
                <option value="7">Coins</option>
                <option value="8">Crazy</option>
                <option value="9">Cyborg</option>
                <option value="10">Eyepatch</option>
                <option value="11">Heart</option>
                <option value="12">Holographic</option>
                <option value="13">Hypnotized</option>
                <option value="14">Laser Eyes</option>
                <option value="15">Robot</option>
                <option value="16">Sad</option>
                <option value="17">Scumbag</option>
                <option value="18">Sleepy</option>
                <option value="19">Sunglasses</option>
                <option value="20">Wide Eyed</option>
                <option value="21">X Eyes</option>
                <option value="22">Zombie</option>
            </select>
        </div>
        <div class="control-group">
            <label>Hat</label>
            <div id="hatValue" class="layer-value">None</div>
            <div class="cycle-buttons">
                <button class="cycle-btn" onclick="cycleLayer('Hat', -1)">Prev</button>
                <button class="cycle-btn" onclick="cycleLayer('Hat', 1)">Next</button>
            </div>
            <select id="hatSelect" onchange="selectLayer('Hat')">
                <option value="0">None</option>
                <option value="1">Army Hat</option>
                <option value="2">Baby's Bonnet</option>
                <option value="3">Bandana Blue</option>
                <option value="4">Bayc Flipped Brim</option>
                <option value="5">Bayc Hat Black</option>
                <option value="6">Bayc Hat Red</option>
                <option value="7">Beanie</option>
                <option value="8">Bowler</option>
                <option value="9">Bunny Ears</option>
                <option value="10">Commie Hat</option>
                <option value="11">Cowboy Hat</option>
                <option value="12">Faux Hawk</option>
                <option value="13">Fez</option>
                <option value="14">Fisherman's Hat</option>
                <option value="15">Girl's Hair Pink</option>
                <option value="16">Girl's Hair Short</option>
                <option value="17">Halo</option>
                <option value="18">Horns</option>
                <option value="19">Irish Boho</option>
                <option value="20">King's Crown</option>
                <option value="21">Laurel Wreath</option>
                <option value="22">Party Hat 1</option>
                <option value="23">Party Hat 2</option>
                <option value="24">Police Motorcycle Helmet</option>
                <option value="25">Prussian Helmet</option>
                <option value="26">S&m Hat</option>
                <option value="27">Safari</option>
                <option value="28">Sea Captain's Hat</option>
                <option value="29">Seaman's Hat</option>
                <option value="30">Short Mohawk</option>
                <option value="31">Spinner Hat</option>
                <option value="32">Stuntman Helmet</option>
                <option value="33">Sushi Chef Headband</option>
                <option value="34">Trippy Captain's Hat</option>
                <option value="35">Vietnam Era Helmet</option>
                <option value="36">Ww2 Pilot Helm</option>
            </select>
        </div>
        <div class="control-group">
            <label>Mouth</label>
            <div id="mouthValue" class="layer-value">Bored</div>
            <div class="cycle-buttons">
                <button class="cycle-btn" onclick="cycleLayer('Mouth', -1)">Prev</button>
                <button class="cycle-btn" onclick="cycleLayer('Mouth', 1)">Next</button>
            </div>
            <select id="mouthSelect" onchange="selectLayer('Mouth')">
                <option value="0">Bored</option>
                <option value="1">Bored Bubblegum</option>
                <option value="2">Bored Cigar</option>
                <option value="3">Bored Cigarette</option>
                <option value="4">Bored Dagger</option>
                <option value="5">Bored Kazoo</option>
                <option value="6">Bored Party Horn</option>
                <option value="7">Bored Pipe</option>
                <option value="8">Bored Pizza</option>
                <option value="9">Bored Unshaven Bubblegum</option>
                <option value="10">Bored Unshaven Cigar</option>
                <option value="11">Bored Unshaven Cigarette</option>
                <option value="12">Bored Unshaven Dagger</option>
                <option value="13">Bored Unshaven Kazoo</option>
                <option value="14">Bored Unshaven Party Horn</option>
                <option value="15">Bored Unshaven Pipe</option>
                <option value="16">Bored Unshaven Pizza</option>
                <option value="17">Bored Unshaven</option>
                <option value="18">Discomfort</option>
                <option value="19">Dumbfounded</option>
                <option value="20">Grin Diamond Grill</option>
                <option value="21">Grin Gold Grill</option>
                <option value="22">Grin Multicolored</option>
                <option value="23">Grin</option>
                <option value="24">Jovial</option>
                <option value="25">Phoneme L</option>
                <option value="26">Phoneme Oh</option>
                <option value="27">Phoneme ooo</option>
                <option value="28">Phoneme Vuh</option>
                <option value="29">Phoneme Wah</option>
                <option value="30">Rage</option>
                <option value="31">Small Grin</option>
                <option value="32">Tongue Out</option>
            </select>
        </div>
        <div class="control-group">
            <label>Earring</label>
            <div id="earringValue" class="layer-value">None</div>
            <div class="cycle-buttons">
                <button class="cycle-btn" onclick="cycleLayer('Earring', -1)">Prev</button>
                <button class="cycle-btn" onclick="cycleLayer('Earring', 1)">Next</button>
            </div>
            <select id="earringSelect" onchange="selectLayer('Earring')">
                <option value="0">None</option>
                <option value="1">Cross</option>
                <option value="2">Diamond Stud</option>
                <option value="3">Gold Hoop</option>
                <option value="4">Gold Stud</option>
                <option value="5">Silver Hoop</option>
                <option value="6">Silver Stud</option>
            </select>
        </div>
    </div>
    <canvas id="nftCanvas" width="512" height="512"></canvas>
    <div class="action-buttons">
        <button id="randomizeBtn" class="action-btn" onclick="randomizeNFT()">Randomize</button>
        <button id="downloadBtn" class="action-btn" onclick="downloadNFT()">Download PNG</button>
        <button id="mintBtn" class="action-btn" disabled>Mint NFT</button>
    </div>
    <div id="modal" class="modal">
        <div class="modal-content">
            <p id="modalMessage"></p>
            <button onclick="closeModal()">OK</button>
        </div>
    </div>
    <div class="nft-viewer" style="margin-top: 20px; width: 100%; max-width: 600px;">
        <h2>Your Bored Ape Shib Club NFTs</h2>
        <div id="nftList" style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
    <script src="https://unpkg.com/ipfs-http-client/dist/index.min.js"></script>
    <script>
        const layers = {
            Background: ["Cool Gray", "Dark Blue", "Dark Purple", "Off White A", "Off White B", "Off White C", "Off White D", "Red"],
            Fur: ["Black", "Blue", "Brown", "Cheetah", "Cream", "Dark Brown", "Death Bot", "DMT", "Golden Brown", "Gray", "Noise", "Pink", "Red", "Robot", "Solid Gold", "Tan", "Trippy", "White", "Zombie"],
            Clothes: ["None", "Admirals Coat", "Bandolier", "Bayc T Black", "Bayc T Red", "Biker Vest", "Black Holes T", "Black Suit", "Black T", "Blue Dress", "Bone Necklace", "Bone Tee", "Caveman Pelt", "Cowboy Shirt", "Guayabera", "Hawaiian", "Hip Hop", "Kings Robe", "Lab Coat", "Leather Jacket", "Leather Punk Jacket", "Lumberjack Shirt", "Navy Striped Tee", "Pimp Coat", "Prison Jumpsuit", "Prom Dress", "Puffy Vest", "Rainbow Suspenders", "Sailor Shirt", "Service", "Sleeveless Logo T", "Sleeveless T", "Smoking Jacket", "Space suit", "Striped Tee", "Stunt Jacket", "Tanktop", "Tie Dye", "Toga", "Tuxedo Tee", "Tweed Suit", "Vietnam Jacket", "Wool Turtleneck", "Work Vest"],
            Eyes: ["3D", "Angry", "Blindfold", "Bloodshot", "Blue Beams", "Bored", "Closed", "Coins", "Crazy", "Cyborg", "Eyepatch", "Heart", "Holographic", "Hypnotized", "Laser Eyes", "Robot", "Sad", "Scumbag", "Sleepy", "Sunglasses", "Wide Eyed", "X Eyes", "Zombie"],
            Hat: ["None", "Army Hat", "Baby's Bonnet", "Bandana Blue", "Bayc Flipped Brim", "Bayc Hat Black", "Bayc Hat Red", "Beanie", "Bowler", "Bunny Ears", "Commie Hat", "Cowboy Hat", "Faux Hawk", "Fez", "Fisherman's Hat", "Girl's Hair Pink", "Girl's Hair Short", "Halo", "Horns", "Irish Boho", "King's Crown", "Laurel Wreath", "Party Hat 1", "Party Hat 2", "Police Motorcycle Helmet", "Prussian Helmet", "S&m Hat", "Safari", "Sea Captain's Hat", "Seaman's Hat", "Short Mohawk", "Spinner Hat", "Stuntman Helmet", "Sushi Chef Headband", "Trippy Captain's Hat", "Vietnam Era Helmet", "Ww2 Pilot Helm"],
            Mouth: ["Bored", "Bored Bubblegum", "Bored Cigar", "Bored Cigarette", "Bored Dagger", "Bored Kazoo", "Bored Party Horn", "Bored Pipe", "Bored Pizza", "Bored Unshaven Bubblegum", "Bored Unshaven Cigar", "Bored Unshaven Cigarette", "Bored Unshaven Dagger", "Bored Unshaven Kazoo", "Bored Unshaven Party Horn", "Bored Unshaven Pipe", "Bored Unshaven Pizza", "Bored Unshaven", "Discomfort", "Dumbfounded", "Grin Diamond Grill", "Grin Gold Grill", "Grin Multicolored", "Grin", "Jovial", "Phoneme L", "Phoneme Oh", "Phoneme ooo", "Phoneme Vuh", "Phoneme Wah", "Rage", "Small Grin", "Tongue Out"],
            Earring: ["None", "Cross", "Diamond Stud", "Gold Hoop", "Gold Stud", "Silver Hoop", "Silver Stud"]
        };

        const layerOrder = ["Background", "Fur", "Clothes", "Eyes", "Hat", "Mouth", "Earring"];
        const currentIndices = { Background: 0, Fur: 0, Clothes: 0, Eyes: 0, Hat: 0, Mouth: 0, Earring: 0 };

        const canvas = document.getElementById("nftCanvas");
        const ctx = canvas.getContext("2d");

        let web3, accounts, contract;
        const CONTRACT_ADDRESS = "0xE204721807f8a9FEe31B766141FBAE9F192856C9";
        const CONTRACT_ABI = [
            {"inputs":[],"stateMutability":"nonpayable","type":"constructor"},
            {"inputs":[{"internalType":"string","name":"uri","type":"string"},{"internalType":"string[]","name":"attributes","type":"string[]"}],"name":"mintNFT","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"tokenURI","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"ownerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"}
        ];

        const shibariumMainnet = {
            chainId: 109,
            chainName: 'Shibarium',
            nativeCurrency: { name: 'BONE', symbol: 'BONE', decimals: 18 },
            rpcUrls: ['https://www.shibrpc.com'],
            blockExplorerUrls: ['https://shibariumscan.io']
        };

        const ipfs = window.IpfsHttpClient({ host: 'ipfs.infura.io', port: 5001, protocol: 'https' });

        function showModal(message) {
            document.getElementById('modalMessage').innerHTML = message;
            document.getElementById('modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        async function connectWallet() {
            const connectButton = document.getElementById('connectWalletBtn');
            if (!window.ethereum) {
                showModal('No wallet detected. Please install <a href="https://metamask.io" target="_blank">MetaMask</a>.');
                return;
            }
            connectButton.classList.add('loading');
            web3 = new Web3(window.ethereum);
            accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            if (!accounts.length) {
                showModal('Please unlock your wallet or connect it.');
                return;
            }
            const chainId = await web3.eth.getChainId();
            if (chainId !== 109) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: web3.utils.numberToHex(109) }]
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [shibariumMainnet]
                        });
                    } else {
                        showModal('Failed to switch network. Please add Shibarium manually.');
                        return;
                    }
                }
            }
            contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
            showModal('Connected to Shibarium successfully!');
            updateWalletAddress();
            document.getElementById('mintBtn').disabled = false;
            fetchOwnedNFTs();
            connectButton.classList.remove('loading');
        }

        async function updateWalletAddress() {
            if (!accounts) {
                document.getElementById('walletAddress').innerText = 'Not connected';
            } else {
                const shortAddress = `${accounts[0].slice(0, 6)}...${accounts[0].slice(-4)}`;
                document.getElementById('walletAddress').innerText = shortAddress;
            }
        }

        function updateLayerValue(layer) {
            document.getElementById(`${layer.toLowerCase()}Value`).textContent = layers[layer][currentIndices[layer]];
            document.getElementById(`${layer.toLowerCase()}Select`).value = currentIndices[layer];
        }

        async function drawLayer(layerName, layerValue) {
            if (layerValue === "None") return Promise.resolve();
            return new Promise((resolve) => {
                const img = new Image();
                img.src = `images/${layerName}/${layerValue}.png`;
                img.onload = () => {
                    ctx.drawImage(img, 0, 0, 512, 512);
                    resolve();
                };
                img.onerror = () => resolve();
            });
        }

        async function updateNFT() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (const layer of layerOrder) {
                const layerValue = layers[layer][currentIndices[layer]];
                await drawLayer(layer, layerValue);
            }
        }

        function cycleLayer(layer, direction) {
            currentIndices[layer] = (currentIndices[layer] + direction + layers[layer].length) % layers[layer].length;
            updateLayerValue(layer);
            updateNFT();
        }

        function selectLayer(layer) {
            currentIndices[layer] = parseInt(document.getElementById(`${layer.toLowerCase()}Select`).value);
            updateLayerValue(layer);
            updateNFT();
        }

        function randomizeNFT() {
            for (const layer of layerOrder) {
                currentIndices[layer] = Math.floor(Math.random() * layers[layer].length);
                updateLayerValue(layer);
            }
            updateNFT();
        }

        function downloadNFT() {
            const link = document.createElement("a");
            link.download = "nft-custom.png";
            link.href = canvas.toDataURL("image/png");
            link.click();
        }

        async function uploadToIPFS(imageData) {
            const blob = await (await fetch(imageData)).blob();
            const result = await ipfs.add(blob);
            return `https://ipfs.infura.io/ipfs/${result.path}`;
        }

        async function mintNFT() {
            if (!web3 || !contract || !accounts) {
                showModal('Please connect your wallet first!');
                return;
            }
            const mintButton = document.getElementById('mintBtn');
            mintButton.classList.add('loading');
            mintButton.disabled = true;
            try {
                showModal('Uploading image to IPFS...');
                const imageData = canvas.toDataURL("image/png");
                const imageUrl = await uploadToIPFS(imageData);
                const attributes = layerOrder.map(layer => layers[layer][currentIndices[layer]]);
                const totalSupply = await contract.methods.totalSupply().call();
                const metadata = {
                    name: `Bored Ape Shib Club #${totalSupply}`,
                    description: "A unique Bored Ape Shib Club NFT",
                    image: imageUrl,
                    attributes: attributes.map((val, i) => ({ trait_type: layerOrder[i], value: val }))
                };
                const metadataBlob = new Blob([JSON.stringify(metadata)], { type: 'application/json' });
                const metadataResult = await ipfs.add(metadataBlob);
                const tokenURI = `https://ipfs.infura.io/ipfs/${metadataResult.path}`;
                showModal('Minting NFT...');
                await contract.methods.mintNFT(tokenURI, attributes).send({ from: accounts[0] });
                showModal('NFT minted successfully!');
                fetchOwnedNFTs();
            } catch (error) {
                showModal('Minting failed: ' + (error.message || 'Unknown error'));
            } finally {
                mintButton.classList.remove('loading');
                mintButton.disabled = false;
            }
        }

        async function fetchOwnedNFTs() {
            if (!web3 || !contract || !accounts) {
                showModal('Please connect your wallet first!');
                return;
            }
            const nftList = document.getElementById('nftList');
            nftList.innerHTML = '<p>Loading your NFTs...</p>';
            const balance = await contract.methods.balanceOf(accounts[0]).call();
            if (balance == 0) {
                nftList.innerHTML = '<p>You don’t own any Bored Ape Shib Club NFTs yet.</p>';
                return;
            }
            nftList.innerHTML = '';
            const totalSupply = await contract.methods.totalSupply().call();
            for (let i = 0; i < totalSupply; i++) {
                const owner = await contract.methods.ownerOf(i).call();
                if (owner.toLowerCase() === accounts[0].toLowerCase()) {
                    const tokenURI = await contract.methods.tokenURI(i).call();
                    await displayNFT(i, tokenURI);
                }
            }
        }

        async function displayNFT(tokenId, tokenURI) {
            const nftList = document.getElementById('nftList');
            let metadata;
            if (tokenURI.startsWith('data:application/json;base64,')) {
                const base64Data = tokenURI.split(',')[1];
                metadata = JSON.parse(atob(base64Data));
            } else {
                const response = await fetch(tokenURI);
                metadata = await response.json();
            }
            const nftDiv = document.createElement('div');
            nftDiv.style.textAlign = 'center';
            nftDiv.style.width = '150px';
            nftDiv.innerHTML = `
                <img src="${metadata.image}" alt="${metadata.name}" style="width: 100%; border-radius: 10px;">
                <p style="font-size: 14px; margin: 5px 0;">${metadata.name} (ID: ${tokenId})</p>
                <input type="text" id="transferAddress${tokenId}" placeholder="Recipient Address" style="width: 100%; padding: 5px; margin-bottom: 5px; border-radius: 5px;">
                <button class="action-btn" onclick="transferNFT(${tokenId})" style="background-color: #FF8A9D;">Transfer</button>
            `;
            nftList.appendChild(nftDiv);
        }

        async function transferNFT(tokenId) {
            if (!web3 || !contract || !accounts) {
                showModal('Please connect your wallet first!');
                return;
            }
            const transferAddress = document.getElementById(`transferAddress${tokenId}`).value;
            if (!web3.utils.isAddress(transferAddress)) {
                showModal('Invalid Ethereum address!');
                return;
            }
            showModal('Transferring NFT...');
            await contract.methods.safeTransferFrom(accounts[0], transferAddress, tokenId).send({ from: accounts[0] });
            showModal('NFT transferred successfully!');
            fetchOwnedNFTs();
        }

        window.onload = () => {
            for (const layer of layerOrder) {
                updateLayerValue(layer);
            }
            updateNFT();
            if (!window.location.protocol.startsWith('http')) {
                showModal('Please run this page via a local server (e.g., "npx serve") to connect MetaMask.');
            } else if (!window.ethereum) {
                showModal('No wallet detected. Please install <a href="https://metamask.io" target="_blank">MetaMask</a>.');
            }
        };

        window.ethereum?.on('chainChanged', (chainId) => {
            if (parseInt(chainId, 16) !== 109) {
                showModal('Switched to wrong network. Please reconnect to Shibarium.');
                web3 = null;
                contract = null;
                accounts = null;
                updateWalletAddress();
                document.getElementById('mintBtn').disabled = true;
            } else {
                connectWallet();
            }
        });

        window.ethereum?.on('accountsChanged', (newAccounts) => {
            if (newAccounts.length) {
                connectWallet();
            } else {
                showModal('Wallet disconnected. Please reconnect.');
                web3 = null;
                contract = null;
                accounts = null;
                updateWalletAddress();
                document.getElementById('mintBtn').disabled = true;
            }
        });

        document.getElementById('connectWalletBtn').addEventListener('click', connectWallet);
        document.getElementById('mintBtn').addEventListener('click', mintNFT);
    </script>
</body>
</html>
